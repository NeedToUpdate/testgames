<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" name="viewport" content="width=device-width, user-scalable=no">
    <script language="javascript" src="lib/vector.js"></script>
    <script language="javascript" src="lib/matrix.js"></script>
    <script language="javascript" src="lib/drawbase.js"></script>
    <script language="javascript" src="lib/PhysicsObject.js"></script>
    <script language="javascript" src="lib/DomObject.js"></script>
    <script language="javascript" src="lib/Character.js"></script>
    <script language="javascript" src="lib/collisioncontainer.js"></script>
    <script language="javascript" src="lib/eventemitter.js"></script>
    <script language="JavaScript" src="external/signature_pad-master/docs/js/signature_pad.umd.js"></script>
    <link rel="stylesheet" href="global_styles.css">
    <title>Artem's Four In A Row</title>
</head>
<style type="text/css">
</style>
<body class="locked">
<h3 id="message">Current Turn: Player <span id="current_turn">1</span></h3>
<button id="btn1">set icon</button>
<button id="btn2">next turn</button>
<button id="btn3">save</button>
<button id="btn4">load</button>
<div style="position:absolute; top: 150px; left: 50px; width: 200px; height: 230px;">
    <canvas id="canvas" height="200px" width="200px"
            style="height: 200px; width: 200px; border: solid black 2px"></canvas>
    <!--<button onclick="PAD.penColor = 'red'">red</button>-->
    <!--<button onclick="PAD.penColor = 'blue'">blue</button>-->
    <!--<button onclick="PAD.penColor = 'deeppink'">pink</button>-->
    <!--<button onclick="PAD.penColor = 'green'">green</button>-->
    <!--<button onclick="PAD.penColor = 'yellow'">yellow</button>-->
    <!--<button onclick="PAD.penColor = 'black'">black</button>-->
    <input id="color_slider" min="-1" max="361" value="0" type="range">
    <button onclick="{let data = PAD.toData(); data.pop(); PAD.fromData(data)}">undo</button>
    <button onclick="PAD.clear()">clear</button>
</div>
<div id="debugdiv" style="position: absolute; z-index: 9999999; top:40px"></div>
<div class="player_icon_container" id="p0Icon_container"><img class="player_icon" id="p0Icon"
                                                              src="data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgNTAgNTAiIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCI+PC9zdmc+==">
</div>
<div class="player_icon_container" id="p1Icon_container"><img class="player_icon" id="p1Icon"
                                                              src="data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgNTAgNTAiIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCI+PC9zdmc+==">
</div>
<div class="player_icon_container" id="p2Icon_container"><img class="player_icon" id="p2Icon"
                                                              src="data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgNTAgNTAiIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCI+PC9zdmc+==">
</div>
<div class="player_icon_container" id="p3Icon_container"><img class="player_icon" id="p3Icon"
                                                              src="data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgNTAgNTAiIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCI+PC9zdmc+==">
</div>
<style>
    .player_icon_container {
        position: absolute;
        top: 5px;
        border: solid black 2px;
        border-radius: 3px;
        transition: 0.5s;
        height: 60px;
        width: 60px;
    }

    #p0Icon_container {
        left: 40%;
        border: solid green 2px;
    }

    #p1Icon_container {
        left: 50%;
    }

    #p2Icon_container {
        left: 60%;
    }

    #p3Icon_container {
        left: 70%;
    }

    .player_icon {
        height: 60px;
        width: 60px;
    }
    #color_slider{
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 25px;
        outline: none;
        opacity: 1;
    }
    #color_slider:hover{
    }
    #color_slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 25px;
        height: 25px;
        background: #F00;
        cursor: pointer;
    }
    #color_slider::-moz-range-thumb {
        width: 25px;
        height: 25px;
        background: #F00;
        cursor: pointer;
    }

</style>
<script>
    let DEBUGDIVON = false;
    if (DEBUGDIVON) {
        if (typeof console !== 'undefined') {
            if (typeof console.log !== 'undefined') {
                console.olog = console.log;
            } else {
                console.olog = function () {
                };
            }
            console.log = function (message) {
                console.olog(message);
                id('debugdiv').append(`\n` + message)
            }
            console.error = console.exception = console.debug = console.info = console.log;
        }
        window.addEventListener('error', e => {
            id('debugdiv').append(`\n` + e.message)
        });
        id('debugdiv').addEventListener('click', () => {
            id('debugdiv').innerText = ''
        })
    }


    let TOP = height * 0.2;
    let LEFT = width * 0.3;
    let lines = [];
    let titles = [];
    let rowNum = 10;
    let colNum = 15;
    let SMALLEST = ((height - TOP * 1.2) / rowNum < (width - LEFT * 1.2) / colNum ? (height - TOP * 1.2) / rowNum : (width - LEFT * 1.2) / colNum) | 0;
    let SMALLEST_NUM = rowNum < colNum ? rowNum : colNum;
    let background = {};
    let foreground = {};
    let col_labels = Array(colNum).fill('').map((x, i) => alphabet[i % 26] + ((i / 26 | 0) === 0 ? '' : (i / 26 | 0)));
    let row_labels = Array(rowNum).fill('').map((x, i) => i + 1);
    let PAD = {};
    let current_turn = 0;

    let imageMatrix = {}

    let sliderStyle = document.createElement("style"); //since the thumb is a psudoelement
    document.head.appendChild(sliderStyle);
    id('color_slider').addEventListener('input',(ev)=>{
        let val = parseInt(id('color_slider').value);
        let rgb = val===-1? [0,0,0]: val===361? [255,255,255]:hslToRgb(val/360,1,0.5)
        sliderStyle.innerHTML = `#color_slider::-webkit-slider-thumb {background: rgb(${rgb.join(',')})!important}
                                    #color_slider::-moz-range-thumb {background: rgb(${rgb.join(',')})!important}`;
        PAD.penColor = `rgb(${rgb.join(',')})`
    });

    //dont want to type out this whole thing, so its generated on the spot
    let grad_string = 'linear-gradient(to right, rgb(0,0,0) 0%,';
    let grad_steps = 36;
    for(let i =0;i<grad_steps;i++){
        let rgb = hslToRgb((i)/grad_steps,0.8,0.5);
        grad_string += `rgb(${rgb.join(',')}) ${(((i)/grad_steps)*94 |0)+3}%`;
        if(i<grad_steps-1){
            grad_string+=','
        }else{
            grad_string+=',rgb(255,255,255) 100%)'
        }
    }
    id('color_slider').style.backgroundImage = grad_string;

    function setup() {
        let board_w = SMALLEST * colNum;
        let board_h = SMALLEST * rowNum;
        background = new Rectangle(LEFT, TOP, board_w, board_h);
        background.color = 'lightgrey';
        for (let i = 0; i <= colNum; i++) {
            let l = Line.fromAngle(LEFT + i * (SMALLEST), TOP, board_h, 90);
            l.color = 'black';
            lines.push(l);
            if (i < colNum) {
                let p = new P(col_labels[i], LEFT + 15 + i * (SMALLEST), TOP - 10, SMALLEST * SMALLEST_NUM).fromCenter();
                p.color = 'black';
                titles.push(p)
            }
        }
        for (let i = 0; i <= rowNum; i++) {
            let l = Line.fromAngle(LEFT, TOP + i * (SMALLEST), board_w);
            l.color = 'black';
            lines.push(l);
            if (i < rowNum) {
                let p = new P(row_labels[i], LEFT - 10, TOP + 15 + i * (SMALLEST), SMALLEST * SMALLEST_NUM).fromCenter();
                p.color = 'black';
                titles.push(p)
            }

        }

        foreground = new Rectangle(LEFT - 1.5, TOP - 1.5, board_w - 1.5, board_h - 1.5).asOutline('black', 3);
        foreground.zIndex = 10000;
        imageMatrix = new Matrix(rowNum, colNum);
        foreground.shape.addEventListener('click', ev => {
            let xy = getPosFromXY(ev.clientX, ev.clientY);
            let piece = id('p' + current_turn + 'Icon').cloneNode();
            let pos = getXYromPos(xy.x, xy.y);
            piece.style.position = 'absolute';
            piece.style.top = pos.y + 'px';
            piece.style.left = pos.x + 'px';
            piece.style.width = SMALLEST + 'px';
            piece.style.height = SMALLEST + 'px';
            document.body.appendChild(piece);
            if (checkObj(imageMatrix.values[xy.y][xy.x])) imageMatrix.values[xy.y][xy.x].piece.remove();
            imageMatrix.values[xy.y][xy.x] = {};
            imageMatrix.values[xy.y][xy.x].piece = piece;
            imageMatrix.values[xy.y][xy.x].player = current_turn;
            let result = checkWin(xy.x, xy.y);
            if (result.result) {
                console.log('player ' + (result.player + 1) + ' is the winner!')
                console.log(result);
                let start = new Vector(getXYromPos(result.start.x, result.start.y))
                start.add(new Vector(SMALLEST / 2, SMALLEST / 2));
                let end = new Vector(getXYromPos(result.end.x, result.end.y));
                end.add(new Vector(SMALLEST / 2, SMALLEST / 2));
                let winLine = new LineFromPoints(start.x, start.y, end.x, end.y)
                winLine.color = 'transparent';
                winLine.thickness = 10;
                winLine.set('borderRadius', '5px');
                winLine.addClass('slowsmoothed');
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        winLine.color = 'limegreen'
                    })
                });
                lines.push(winLine);
            } else {
                nextTurn()
            }
        });


        if (!checkObj(PAD)) PAD = new SignaturePad(id('canvas'),{minWidth: 4,maxWidth:8});
        for (let i = 0; i < 4; i++) {

            id('p' + i + 'Icon').style.height = 60 + 'px';
            id('p' + i + 'Icon').src = PAD.toDataURL();
        }
    }

    function removeAll() {
        if (checkObj(background)) background.remove();
        if (checkObj(foreground)) foreground.remove();
        lines.forEach(line => {
            line.remove()
        });
        titles.forEach(title => {
            title.remove();
        })
        background = {}
        foreground = {}
        lines = [];
        titles = [];
    }

    function getPosFromXY(x, y) {
        let board_w = SMALLEST * colNum;
        let board_h = SMALLEST * rowNum;
        let col = ((x - LEFT) / board_w) * colNum | 0;
        let row = ((y - TOP) / board_h) * rowNum | 0;
        return {x: col, y: row};
    }

    function getXYromPos(x, y) {
        let board_w = SMALLEST * colNum;
        let board_h = SMALLEST * rowNum;
        let col = (x / colNum) * board_w + LEFT;
        let row = (y / rowNum) * board_h + TOP;
        return {x: col, y: row};
    }

    function nextTurn() {
        current_turn++;
        current_turn %= 4;
        id('current_turn').innerText = current_turn + 1;
        for (let i = 0; i < 4; i++) {
            id('p' + i + 'Icon_container').style.border = 'solid ' + (i === current_turn ? 'green' : 'black') + ' 2px';
            id('p' + i + 'Icon_container').style.boxShadow = (i === current_turn ? '0 0 5px 5px limegreen' : '');
        }
    }

    id('btn1').addEventListener('click', () => {
        id('p' + current_turn + 'Icon').src = PAD.toDataURL();
        PAD.clear();
        nextTurn();
    });
    id('btn2').addEventListener('click', nextTurn);
    id('btn3').addEventListener('click', save);
    id('btn4').addEventListener('click', load);

    function save() {
        for (let i = 0; i < 4; i++) {
            localStorage.setItem(i + 'Icon', id('p' + i + 'Icon').src)
        }
        let values = imageMatrix.values.map(row => row.map(x => x.player));
        localStorage.setItem('pieces', JSON.stringify(values));
        localStorage.setItem('colNum', colNum);
        localStorage.setItem('rowNum', rowNum);
    }

    function load() {
        removeAll()
        colNum = parseInt(localStorage.getItem('colNum'));
        rowNum = parseInt(localStorage.getItem('rowNum'));
        SMALLEST = ((height - TOP * 1.2) / rowNum < (width - LEFT * 1.2) / colNum ? (height - TOP * 1.2) / rowNum : (width - LEFT * 1.2) / colNum) | 0;
        SMALLEST_NUM = rowNum < colNum ? rowNum : colNum;
        setup();
        for (let i = 0; i < 4; i++) {
            id('p' + i + 'Icon').src = localStorage.getItem(i + 'Icon');
        }
        imageMatrix.values = JSON.parse(localStorage.getItem('pieces')).map((row, i) => row.map((val, j) => {
            if (val !== null) {
                let piece = id('p' + val + 'Icon').cloneNode();
                let pos = getXYromPos(j, i);
                piece.style.position = 'absolute';
                piece.style.top = pos.y + 'px';
                piece.style.left = pos.x + 'px';
                piece.style.width = SMALLEST + 'px';
                piece.style.height = SMALLEST + 'px';
                document.body.appendChild(piece);
                return {player: parseInt(val), piece: piece}
            } else {
                return 0;
            }

        }));
    }

    function isValid(x, y) {
        // if(x===3 && y===3) return false;
        // return !(x === 2 && y === 3);
        return true;
    }

    function checkWin(x, y) {
        function checkSpot(x, y, player, dir) {
            if (x < 0 || y < 0 || x > colNum - 1 || y > rowNum - 1) return 0;
            let check_p = imageMatrix.values[y][x].player;
            if (player === check_p) {
                return 1 + checkSpot(x + dir.x, y + dir.y, player, dir);
            } else {
                return 0;
            }
        }

        let player = imageMatrix.values[y][x].player;
        if (!isValid(x, y) || player === undefined) return {result: false, player: player};
        //directions
        //  7  0  1
        //  6  X  2
        //  5  4  3
        let dirs = [{x: 0, y: -1}, {x: 1, y: -1}, {x: 1, y: 0}, {x: 1, y: 1}, {x: 0, y: 1}, {x: -1, y: 1}, {
            x: -1,
            y: 0
        }, {x: -1, y: -1}];
        if (x <= 0) {
            dirs[5] = -1; //cant be directions 5 6 or 7
            dirs[6] = -1;
            dirs[7] = -1;
        }
        if (y <= 0) {
            dirs[7] = -1;
            dirs[0] = -1;
            dirs[1] = -1;
        }
        if (y >= rowNum - 1) {
            dirs[5] = -1;
            dirs[4] = -1;
            dirs[3] = -1;
        }
        if (x >= colNum - 1) {
            dirs[1] = -1;
            dirs[2] = -1;
            dirs[3] = -1;
        }
        //console.log(dirs);
        let dirNums = Array(8).fill(0);
        for (let i = 0; i < 8; i++) {
            let dir = dirs[i];
            if (dir !== -1) {
                dirNums[i] = checkSpot(x, y, player, dir);
            }
        }
        for (let i = 0; i < 4; i++) {
            let index = i + 4;
            if (dirNums[i] + dirNums[index] - 1 >= 4) {
                let xy1 = {x: x + dirs[i].x * (dirNums[i] - 1), y: y + dirs[i].y * (dirNums[i] - 1)}
                let xy2 = {x: x + dirs[index].x * (dirNums[index] - 1), y: y + dirs[index].y * (dirNums[index] - 1)}
                return {result: true, player: player, dir: i, start: xy1, end: xy2};
            }
        }
        return {result: false, player: player}
    }


    requestAnimationFrame(() => requestAnimationFrame(setup));
</script>

</body>
</html>
<html>

<head>
    <meta charset="UTF-8" name="viewport" content="width=device-width, user-scalable=no">
    <script language="javascript" src="./lib/vector.js"></script>
    <script language="javascript" src="./lib/matrix.js"></script>
    <script language="javascript" src="./lib/drawbase.js"></script>
    <script language="javascript" src="./lib/DomObject.js"></script>
    <script language="javascript" src="./lib/PhysicsObject.js"></script>
    <script language="javascript" src="./lib/eventemitter.js"></script>
    <link rel="stylesheet" href="global_styles.css">
</head>

<body class="locked">
    <button id="spin" class="bluebtn">Spin!</button>
    <p>Speed: <span id="speedspan"></span> deg per second</p>
    <script>
        let animals = [
            'cat', 'dog', 'horse',
            'clownfish', 'seahorse', 'crocodile',
            'elephant', 'monkey', 'owl',
            'penguin', 'frog',  'salamander', 'snake', 'whale',
            'sheep', 'tiger', 'lion', 'eagle', 'dolphin', 'shark', 'lizard','crab','worm','lobster','fly','spider','jellyfish','snail',
            'octopus','butterfly','starfish','mosquito','ant','scorpion','dragonfly'
        ];
        function getRandomArray(num) {
            let nums = [];
            let escape = 0;
            while (nums.length < num && escape < 1000) {
                let n = Math.floor(Math.random() * animals.length)
                if (nums.indexOf(n) === -1) {
                    nums.push(n);
                }
                escape++;
            }
            console.log(nums);
            return nums.map(x => animals[x]);
        }
        let images = getRandomArray(8);
        let imageDivs = [];
        let weights = images.map(x => 1);
        let LOADED_IMAGES = new ImageLoader('./images/', images);


        for (let i = 0; i < images.length; i++) {
            console.log(`%c ${images[i]} weight: ${weights[i]}`, 'color: darkblue');
        }




        //Debug
        let LOGGING = true;




        let interval = 10;

        //speen of rotation
        let speed = 1;
        let clicked = false;
        let originX = width/2;
        let originY = height/2 + height/3;
        let circleRadius = 250;
        let wheelShape = new Circle(originX,originY, circleRadius);
        let lines = [];
        let radius = 150;

        function getX(angle, customRadius) {
            if (customRadius) {
                return originX + customRadius * Math.cos(angle/180*Math.PI);
            }
            return originX + radius * Math.cos(angle);
        };
        function getY(angle, customRadius) {
            if (customRadius) {
                return originY + customRadius * Math.sin(angle/180*Math.PI);
            }
            return originY + radius * Math.sin(angle);
        };
        let sections = [];
        function setup(){
            return new Promise(resolve=>{
                let total = images.length;
                let check = 0;
                images.forEach((x,i)=>{
                    let l = Line.fromAngle(originX,originY, 250, (360/total)*i + 180/total ,3);
                    l.color = 'blue';
                    lines.push(l);
                    let r = 200;
                    let img = new Img(LOADED_IMAGES[images[i]],getX((360/total)*i,r),getY((360/total)*i,r),80,undefined,(360/total)*i +90).fromCenter()
                    imageDivs.push(img)
                    img.onLoad(()=>{
                        check++;
                        if(check===total){
                            resolve()
                        }
                    })
                });
                wheelShape.color = 'yellow';
                wheelShape.border = 'blue solid 3px';
            })
        };
        setup();
        function spinTo(angle) {
            imageDivs.forEach(image=>{
                image.x = getX(image.angle - angle,200);
                image.y = getY(image.angle - angle,200);
                image.rotateTo(image.angle - angle +90);
            });
            lines.forEach(line=>{
                line.rotateTo(line.angle-angle);
            })
        };


        let SPINNING = false;
        let spinInt = 0;
        let main_theta = 1;
        setup().then(()=>{
            requestAnimationFrame(()=>{
                spinTo(0)
            });
        });
        let DRAGGING = false;
        let event = {};
        let rSqrd = circleRadius**2
        function withinBorders(x,y){
            //check if distance from origin point isnt more than the circle radius
            let unsqd = (originX-x)**2 + (originY-y)**2
            return unsqd<rSqrd;
        }
        function clickDown(e){
            if(withinBorders(e.clientX,e.clientY)){
                DRAGGING = true;
                event = e;
            }
        }
        function clickUp(e){
            console.log('let go')
            DRAGGING = false;
            event = e;
            spinWithSpeed()
        }
        let stopBuffer = [];
        function dragWheel(e){
                if(DRAGGING && withinBorders(e.clientX,e.clientY) && window.performance.now()-lastcheck > 17){
                    let dist = Math.sqrt((originX-e.clientX)**2 + (originY-e.clientY)**2);
                    let speed = mapNum(dist,0,radius,0.3,2.5);
                    let deltaX = (e.clientX - event.clientX)/speed;
                    let deltaY = (e.clientY - event.clientY)/speed;
                    let xmid = wheelShape.x + wheelShape.width/2;
                    let ymid = wheelShape.y + wheelShape.height/2;
                    event = e;
                    let deltaV =  Math.abs(deltaX)>Math.abs(deltaY)? e.clientY<ymid?deltaX : deltaX*-1 : e.clientX>xmid?deltaY:deltaY*-1;
                    main_theta -= deltaV;
                    spinTo(main_theta);
                    if(Math.sign(currSpeed)+Math.sign(deltaV*-1)===0){
                        stopBuffer.push('blah');
                        if(stopBuffer.length>7){
                            //opposite directions;
                            clearInterval(speedSpinInt);
                            let l = thetaHist.length;
                            thetaHist.splice(0,l/2 |0);
                            thetaHist = thetaHist.concat(new Array(l/2).fill(0));
                            console.log('opp')
                        }
                    }else{
                        stopBuffer.pop();
                    }

                    lastcheck = window.performance.now()
                }else if(DRAGGING && window.performance.now()-lastcheck > 17){
                    console.log('let go');
                    spinWithSpeed()
                }

        }

        document.body.addEventListener('touchend',e=>{
            clickUp(e.touches[0])
        });
        document.body.addEventListener('mouseup',clickUp);
        document.body.addEventListener('mousedown',clickDown);
        document.body.addEventListener('touchstart',e=>{
            clickDown(e.touches[0])
        });
        let lastcheck = 0;
        document.body.addEventListener('mousemove',dragWheel);
        document.body.addEventListener('touchmove',e=>{
            dragWheel(e.touches[0])
        });

        let thetaHist = [];
        let lastTheta = 1;
        let want_check = false;
        let currSpeed = 0;
        let lightsAreOn = false;
        function speedCheck(){
            if(thetaHist.length>=200) thetaHist.shift();
            thetaHist.push(main_theta-lastTheta);
            lastTheta = main_theta
            if(thetaHist.length===200){
                currSpeed = thetaHist.reduce((a,b)=>a+b);
                id('speedspan').innerText = Math.abs(currSpeed).toPrecision(4)
                if(want_check){
                    console.log('speed is ' + currSpeed + ' degrees per second')
                    want_check = false;
                }
                if(Math.abs(currSpeed)>500 && !lightsAreOn){
                    lightsAreOn = true;
                    console.log('lights')
                }else if(lightsAreOn && Math.abs(currSpeed)<50){
                    lightsAreOn = false;
                    console.log('turn off lights')
                }
            }
        }
        let checkerInt = setInterval(speedCheck,5);

        let speedSpinInt = 0;
        function spinWithSpeed(speed){
                let del = speed/200 || currSpeed/200;
                clearInterval(speedSpinInt);
                speedSpinInt = setInterval(()=>{
                    main_theta += del;
                    let drag = 0.01;
                    if(del<0){
                        del += drag
                    }else if(del>0){
                        del -= drag
                    }
                    if(Math.abs(del)<0.1){
                        clearInterval(speedSpinInt)
                        speedSpinInt = 0;
                    }
                    spinTo(main_theta)
                },5)
        }

        button = document.getElementById('spin');
        button.addEventListener('click', function () {

           if(SPINNING){
               clearInterval(spinInt)
           }else{
               spinInt = setInterval(()=>{
                   spinTo(main_theta);
                   main_theta+=3;
               },1000/60)
           }
            SPINNING = !SPINNING
        });

    </script>
</body>

</html>